<?phpsession_start();include ("dbconnect.php");$target_dir = "pdfs/";$target_file = $target_dir . basename($_FILES["fileToUpload"]["name"]);$filename = basename($_FILES["fileToUpload"]["name"]); //con .pdf$filesize = $_FILES["fileToUpload"]["size"];$requisiti = 1;$esiste = 1;$formato = pathinfo($target_file, PATHINFO_EXTENSION);function count_pages($pdfname){	$pdftext = file_get_contents($pdfname);	$num = preg_match_all("/\/Page\W/", $pdftext, $dummy);	return $num;}if (($formato != "pdf") OR ($filesize > 2 * 1048576)){	$requisiti = 0;}if (file_exists($target_file)){	$esiste = 0;}if ($esiste == 0){	header("location:stampa.php?error=3");	die();}if ($requisiti == 0){	header("location:stampa.php?error=1");}else{	if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file))	{		$nrpagine = count_pages($target_file);		$queryfile = "INSERT INTO files (id_file, title, proprietario, pagine, size, timestamp) VALUES  (NULL, '" . mysqli_real_escape_string($link, $filename) . "','" . $_SESSION['userid'] . "', '" . $nrpagine . "', '" . $filesize . "', CURRENT_TIMESTAMP)";		if (mysqli_query($link, $queryfile))		{			$querygetfileid = "SELECT id_file FROM files WHERE title='" . mysqli_real_escape_string($link, basename($_FILES['fileToUpload']['name'])) . "'";			$result = mysqli_query($link, $querygetfileid);			$row = mysqli_fetch_row($result);			header("location:stampa.php?success=1&file_id=$row[0]");		}		else		{			echo "Unexpetcted error <br />";			echo mysqli_error($link);		}	}	else	{		header("location:stampa.php?error=2");	}}?>

